@page "/newresult"
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IJSRuntime JS
@using F1Pontszamitos_S6.Client.Componenets
@rendermode @( new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>New Race Result</PageTitle>
<link rel="stylesheet" href="css/newresult.css">
<script src="Scripts/password.js"></script>

@if(nextRace is null)
{
    <Loader/>
}
else
{
    <p class="resultOfThe">Result of the @nextRace</p>

    <div class="resultWrapper">
        <EditForm Model="@raceResult" OnSubmit="HandleSubmit">
            
            
                <div class="outer-box">
                <div class="curb leftCurb"></div>
                <div class="container">
                    <div class="line top"></div>

                    <div class="finishline"></div>

                    <div class="line bottom"></div>

                    <Grid driverNames="driverNames" raceResult="raceResult"/>
                    
                </div>
                <div class="curb rightCurb"></div>
            </div>

            <label class="mt-4">Fastest Lap</label>
            <InputText @bind-Value="fastestMan" class="form-control"></InputText>

            <button type="submit" class="btn btn-primary mt-4">Add Result</button>
        </EditForm>
    </div>
}
    


@code {
    string[] raceResult = new string[20];
    string? fastestMan = null;
    string? nextRace = null;
    List<string> driverNames = new();

    // private async Task CheckPassword()
    // {
    //     JS.InvokeVoidAsync("passwordProtection");
    // }


    protected override async Task OnInitializedAsync()
    {
        //await CheckPassword();

        var delayTask = Task.Delay(500);

        var HttpRequestTaskCurrentRace =  Http.GetStringAsync("api/main/nextRace");

        var HttpRequestTaskDNames = Http.GetFromJsonAsync<List<string>>("api/drivers/names");


        await Task.WhenAll(delayTask, HttpRequestTaskCurrentRace, HttpRequestTaskDNames);

        if (HttpRequestTaskCurrentRace is not null)
        {
            nextRace = await HttpRequestTaskCurrentRace;
        }

        if (HttpRequestTaskDNames is not null)
        {
            driverNames = await HttpRequestTaskDNames;
        }

    }

    async Task HandleSubmit()
    {

        for (int i = 0; i < raceResult.Length; i++)
        {

            var result = await Http.PutAsJsonAsync($"api/drivers/{raceResult[i]}/{i+1}/{fastestMan}", new Driver());
        }

        NavManager.NavigateTo("standings");
    }

}
